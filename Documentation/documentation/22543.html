<!DOCTYPE html>
<html>
<head>
<meta http-equiv=Content-Type content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css" href="./images/WikiTheme2.css"/>
<link rel="stylesheet" type="text/css" href="./images/bootstrap.min.css"/>
<title>Manual Synchronization Code Sample</title>
</head>
<body bgcolor="#FFFFFF" style="display: block;margin: 8px;"><span id="W0004BODY" class="WikiBody"><table border=0 width=100%><tr><td><div align="right"><FONT face=Verdana size=2><a href =https://wiki.genexus.com/commwiki/wiki?22543,, target=_"blank">Newest Version</a></FONT></div></td></tr></table><h1 class="WikiName">Manual Synchronization Code Sample</h1>
<!--Manual Synchronization Code Sample--><table class="TableWikiBody" id="tblwikibody"><tbody><tr><td><p><a href="22266.html">Manual synchronization</a> can be set as the Synchronization criteria for <a href="22237.html">SD Offline Apps</a> with the <a href="22223.html">Data Receive Criteria property</a>.</p>

<div style="background-color: rgb(255,255,204);border-left: 6.0px solid rgb(255,255,0);margin-bottom: 15.0px;padding: 4.0px 12.0px;"><b>Note:</b> This document aims to explain how to perform a full manual synchronization between the device and the server tables, that means, avoiding the synchronizations programs automatically generated by GeneXus (first bits of GeneXus Tilo does not include this option). So, before continuing with this approach, consider using <a href="22267.html">Automatic Sync</a> or <a href="22266.html">Manual sync with automatically generated programs</a> To explain how to do this synchronization some code example was taken from the <a href="https://wiki.genexus.com/commwiki/wiki?20698,," target="_blank">Sales with manual synch example</a></div>

<p>The following are the main actions to complete the synchronization.</p>

<ul>
	<li>Master Tables Service Layer.</li>
	<li>Invoke Master Services.</li>
	<li>Triggering of the Synchronization process.</li>
	<li>Event Tables Service Layer</li>
	<li>Send Events to the Server.</li>
</ul>

<h2><a id="1.+Master+Table+Service+Layer" class="HashLink" href="#1.+Master+Table+Service+Layer">1. Master Table Service Layer</a></h2>

<p>This is the Rest services exposed on the Web Server so that the devices can get the Master data they need to start working.<br />
For example, to expose the Customer Master table the following is needed:</p>

<ul>
	<li>SDT based on the Customer Transaction.</li>
	<li>Data Provider which will return all or a part of the registers of this TRN</li>
</ul>

<pre class="Code" style="margin-left: 40.0px;">
SDTCustomer
{
      CustomerId
      CustomerName
      CustomerAddress
      CustomerPhone
      CustomerLocation
      CustomerDistanceToMe
}</pre>

<p style="margin-left: 40.0px;"><br />
This Data Provider will return a collection of SDTCustomers; in this case, returns all the registers of the Customers.<br />
To enable this data provider to be exposed as a Rest service it is needed to set a property explained <a href="11231.html">here</a>. Lastly set the Web Service Protocol to REST Protocol.</p>

<h2><a id="2.+Invoke+Master+Services" class="HashLink" href="#2.+Invoke+Master+Services">2. Invoke Master Services</a></h2>

<p>These are the Objects needed to execute the services of the Master data service layer and insert the data into the device. This code will be executed 100% on the device.<br />
A procedure with the following code can be created.</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
For each Customer 
    delete
Endfor</pre>

<p>Delete all the Customers on the local database. Other strategies may vary and can do incremental synchronizations. In this case, the tables are deleted before the Master Synchronizations.</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
GetParameters.Call(&amp;serverprotocol, &amp;serverHost, &amp;serverBaseURL, &amp;serverRestBaseURL, &amp;serverPort)</pre>

<p>The GetParameters procedure retrieves the parameters of the <a href="6932.html">HttpClient data type</a>. The values can be as the following:</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
&amp;serverprotocol = &quot;http&quot;
&amp;serverHost = &quot;apps3.genexusx.com&quot;
&amp;serverBaseURL= &quot;/Idfe4nFfdfFwf4jf442nvanaf4r3rn904Faf/&quot;
&amp;serverRestBaseURL = &quot;/Idfe4nFfdfFwf4jf442nvanaf4r3rn904Faf/rest/&quot;
&amp;serverPort = 80</pre>

<p>Initial set up of the HTTPClient Object in order to consume rest services from the service layer.</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
&amp;httpclient.Host = &amp;serverHost.Trim()
&amp;httpclient.Port = &amp;serverPort
&amp;httpclient.BaseUrl = &amp;serverRestBaseURL.Trim()
&amp;httpclient.AddHeader(!'Content-type',!'application/json')
&amp;httpclient.Execute(!'GET', !'GetAllCustomers?fmt=json')
</pre>

<p>The Rest Service is invoked, GET method is used to retrieve the resource GetAllCustomers created in step 1. The String returned, in json format, is going to be stored on the &amp;httpclient variable.</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
&amp;customerslist.FromJson(&amp;httpclient.ToString())</pre>

<p>&amp;customerlist is a variable based on the SDT created on 1.a. The FromJson method will load the variable with all the registers brought by the server, this can only be done because the rest service returns a json representation of the same SDT.</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
For &amp;Customer in &amp;CustomersList
  &amp;CustomerBC = new()
  &amp;CustomerBC.CustomerId = &amp;Customer.CustomerId
  &amp;CustomerBC.CustomerName = &amp;Customer.CustomerName
  &amp;CustomerBC. CustomerAddress = &amp;Customer.CustomerAddress
  &amp;CustomerBCCustomerPhone = &amp;Customer.CustomerPhone
  &amp;CustomerBC.CustomerLocation = &amp;Customer.CustomerLocation
  &amp;CustomerBC.CustomerDistanceToMe = &amp;customer.CustomerDistanceToMe
  &amp;CustomerBCCustomerVisited = False
  &amp;CustomerBC.Save()
endfor</pre>

<p>Iterate through the &amp;CustomersList and insert via BusinessComponent all the Customers on the local database.<br />
The reasons for using Business Component can be seen on the <a href="22276.html">Best Practices for Manual Synchronization</a>.</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
commit</pre>

<p>The final instruction to commit the changes of the insertion on the local database.</p>

<h2><a id="3.+Trigger+The+Synchronization" class="HashLink" href="#3.+Trigger+The+Synchronization">3. Trigger The Synchronization</a></h2>

<p>As seen before <a href="22269.html">the synchronization</a> is always started by the device. The developer has to choose whether the user can consciously trigger this action (for example by tapping on a Load Data or Synchronize button) or unconsciously (for example, by entering to a screen the synchronization is triggered). Either way there this code is triggered on the Smart Device (the client side).<br />
The User Event to Load Data can be like the following:</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
Event 'Load Master Data'
Composite
  ProgressIndicator.Title = &quot;Data synchronization...&quot;
  ProgressIndicator.Description = &quot;Checking connectivity...&quot;
  ProgressIndicator.Type = 0
  ProgressIndicator.Show()
  &amp;server = getServerFromParameters() // returns the URL of the server host where the synchronization is going to be made
  &amp;IsConnected = NetWorkAPI.IsServerAvailable(&amp;server)
  if &amp;isConnected
     ProgressIndicator.Description = &quot;Retrieving data from server...&quot;
     &amp;result = SyncReceive()
     /****************************************************************************************************** 
        Note: If the device is connected to the server then the synchronization can be done. In some
        scenarios, you will also want to check which connection is used to see if there are synchronizations 
        which need or not wifi or 3g, etc. This can be done using [[Network external object]] 
     *******************************************************************************************************/
  else
     &amp;result = &quot;No connection detected&quot;
  endif
  ProgressIndicator.Hide()
  msg(&amp;result)
Endcomposite
Endevent</pre>

<h2><a id="4.+Event+Tables+Service+Layer" class="HashLink" href="#4.+Event+Tables+Service+Layer">4. Event Tables Service Layer</a></h2>

<p>The Transactions that generate the Event Tables are also going to be on the web server application. So the easiest way to generate the service to insert/update registers online is the Transaction itself. This is done with the expose as web service property of the Transaction which will expose the Transaction's CRUD services for the REST protocol. </p>

<p>The insert service for PurchaseOrder will be:</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
&lt;host&gt;/&lt;baseUrl&gt;/rest/PurchaseOrder/0</pre>

<p>example:</p>

<p>http://apps3.genexusx.com/Idfe4nFfdfFwf4ja42nvanaf4r3rn904Faf/rest/PurchaseOrder/0</p>

<h2><a id="5.+Send+Events+to+the+Server" class="HashLink" href="#5.+Send+Events+to+the+Server">5. Send Events to the Server</a></h2>

<p>This step is going to send to the web server (and insert there ) the data saved locally to the Event Tables. Following the sample and in order to do that, a POST to the PurchaseOrder REST service has to be executed for each record of that transaction.</p>

<p>After the &amp;httpclient variable is initialized like in step 2, code the following:</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
&amp;ServerPOrder = LoadPurchaseOrder()</pre>

<p>Load all the Purchases Orders that were added to the offline database. &amp;ServerPOrder is based on an SDT based on the Transaction ServerPOrder.</p>

<pre class="prettyprint lang-genexus" style="max-width: 100%">
For &amp;ServerPOrderItem in &amp;ServerPOrder // Iterate through the Purchase Orders loaded from the local database.
   &amp;body = &amp;ServerPOrderItem.ToJson()  // Get the JSON representation of the Purchase Orders.
   &amp;httpclient.AddString(&amp;body)        // Attach the body to the HTTP POST.
   &amp;httpclient.Execute(!'POST', !'PurchaseOrderSrv/0') // Execute to insert the purchase order on the server
    If &amp;httpclient.StatusCode = 201 or  &amp;httpclient.StatusCode = 200  
     //Succesfull Post 
   else 
     //Error in Post 
   Endif 
Endfor
</pre>

<p>The rest of the code can be found on <a href="https://wiki.genexus.com/commwiki/wiki?20698,," target="_blank">Sales with manual synch example</a><br />
Note: Sales Force Offline Example also shows how to synch Multimedia, specifically <a href="15204.html">Image data type</a> fields.</p>

<p><br />
</p>

<p><br />
</p>
<br /><br /></td></tr></tbody></table><script src="./images/run_prettify.js?lang=genexus"></script><hr /><table id="Pages" class="Table" cellpadding="1" cellspacing="2" style=" width: 100%;" ><TR><TD><b>Backlinks</b></TD></TR><TR><TD><a href="22276.html">Best Practices for Manual Synchronization</a></TD><TD><a href="22266.html">Coding your Data Synchronization programs</a></TD><TD><a href="31310.html">Network external object</a></TD></TR><TR><TD><a href="22228.html">Toc:Offline Native Mobile Applications</a></TD></TR></table>
</span></body>
</html><hr /><table id="Pages" class="Table" cellpadding="1" cellspacing="2" style=" width: 100%;" ><TR><td align="left"><font face="Verdana" size="1"><em>Source: <a href="https://wiki.genexus.com" target=_blank>wiki.genexus.com</a></em></font></td><td align="right"><font face="Verdana" size="1"><em>Last modification: 07/31/20 01:19 PM</em></font></td></TR></table></font>