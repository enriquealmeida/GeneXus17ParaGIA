<?xml version="1.0" encoding="utf-8"?>
<ExportFile>
  <KMW>
    <MajorVersion>3</MajorVersion>
    <MinorVersion>1</MinorVersion>
    <Build>80183</Build>
  </KMW>
  <Source kb="836c5f09-8777-4129-a040-61f24d93c42a" UNCPath="\\PCKBS\C$\Projects\KBs\KBSecurity">
    <Version guid="7043d77a-8594-4c26-8be1-51830a89cb33" name="KBSecurity" />
  </Source>
  <Actions />
  <Objects>
    <Object parent="WWPBaseObjects.Security" parentType="00000000-0000-0000-0000-000000000008" parentGuid="afa47377-41d5-4ae8-9755-6f53150aa361" user="JALVAREZHP\usuario" versionDate="0001-01-01T00:00:00.0000000" lastUpdate="2016-04-08T13:46:41.0000000Z" checksum="4f57fdb90957ee41c2db02e3a248e458" guid="d84d3c2f-fd07-49c3-b791-a59f40712e77" name="SecGAMUpdatePermissions" type="84a12160-f59b-4ad7-a683-ea4481ac23e9" description="Sec GAMUpdate Permissions">
      <Part type="528d1c06-a9c2-420d-bd35-21dca83f12ff">
        <Source>
	<![CDATA[
	/* Generated by DVelop Work With Plus Pattern [Start] - Do not change */

&RoleName = !''
&GAMApplicationId = !''

	/* Generated by DVelop Work With Plus Pattern [End] - Do not change */

msg(format(!"Administrator role: '%1'", &RoleName), status)
msg(format(!"GAM application id: '%1'", &GAMApplicationId), status)

&GAMApplication = GAMRepository.GetApplicationByGUID(guid.FromString(&GAMApplicationId), &Errors)
&SecGAMFunctionalitiesToLoadCollection = SecGAMGetAdvancedSecurityWWPFunctionalities()
&isOK = True
//Delete all the permissions that are not XXX_Execute, XXX_Insert, XXX_Update, XXX_Delete, XXX_FullControl nor Custom_XXX 
&GAMApplicationPermissions = &GAMApplication.GetPermissions(&GAMApplicationPermissionFilter, &Errors)
&GAMRoleFilter.Name = &RoleName
For &GAMApplicationPermission in &GAMApplicationPermissions
	If Not(&GAMApplicationPermission.Name.ToLower() = 'is_gam_administrator' or &GAMApplicationPermission.Name.ToLower() like '%_execute' or &GAMApplicationPermission.Name.ToLower() like '%_insert' or &GAMApplicationPermission.Name.ToLower() like '%_update' or &GAMApplicationPermission.Name.ToLower() like '%_delete' or &GAMApplicationPermission.Name.ToLower() like '%_fullcontrol' or &GAMApplicationPermission.Name.ToLower() like 'custom_%')
		//Search the permission within the ones added by WorkWithPlus
		&GAMApplicationPermissionName = &GAMApplicationPermission.Name
		do 'SearchPermissionInDataProvider'
		If Not &Exists
			//Delete the permission
			For &GAMRole in GAMRepository.GetRoles(&GAMRoleFilter, &Errors)
				&GAMPermissionFilter.ApplicationId = &GAMApplication.Id
				&GAMPermissionFilter.Name = &GAMApplicationPermission.Name.Trim()
				For &GAMPermission in &GAMRole.GetPermissions(&GAMPermissionFilter, &Errors)
					msg(format(!"Deleting permission '%1' from role '%2'...", &GAMApplicationPermission.Name.Trim(), &GAMRole.Name.Trim()), status)
					&isOK = &GAMRole.DeletePermission(&GAMPermission, &Errors)
					If Not &isOK
						msg(format(!"The following errors ocurred while deleting permission '%1' from role '%2':", &GAMApplicationPermission.Name.Trim(), &GAMRole.Name), status)
						do 'ShowErrorMessages'
					Endif
				EndFor
			EndFor
			msg(format(!"Deleting permission '%1' from GAM repository...", &GAMApplicationPermission.Name.Trim()), status)
			&isOK = &GAMApplication.DeletePermission(&GAMApplicationPermission, &Errors)
			If Not &isOK
				msg(format(!"The following errors ocurred while deleting permission '%1':", &GAMApplicationPermission.Name), status)
				do 'ShowErrorMessages'
			Endif
		EndIf
	EndIf
EndFor

If &isOK
	//Create the new permissions and assign them to admin role
//	&GAMApplicationId = "d3d36495-f571-48e9-a044-9d7bced8a949"
	If not &RoleName.Trim().IsEmpty()
		msg(format(!"Getting role '%1' from GAM repository...", &RoleName), status)
		&GAMApplication = GAMRepository.GetApplicationByGUID(guid.FromString(&GAMApplicationId), &Errors)
		For &GAMRole in GAMRepository.GetRoles(&GAMRoleFilter, &Errors)
			If &GAMRole.Name.Trim() = &RoleName.Trim()
				&Id = &GAMRole.Id
				Exit
			Endif
		EndFor
		If &Id.IsEmpty()
			msg(format(!"Role '%1' not found", &RoleName), status)
			&GAMRoleFilter = new()
			&RoleNames = ''
			For &GAMRole in GAMRepository.GetRoles(&GAMRoleFilter, &Errors)
				&RoleNames += ', ' + &GAMRole.Name.Trim()
			EndFor
			If not &RoleNames.IsEmpty()
				msg(format(!"The available roles are: %1", &RoleNames.Substring(3, &RoleNames.Length() -2)), status)
			EndIf
		EndIf
	EndIf
	If not &Id.IsEmpty()
		&GAMRole.Load(&Id)
	EndIf
	For &SecGAMFunctionalitiesToLoad in &SecGAMFunctionalitiesToLoadCollection
		Do 'SearchPermissionAlreadyCreated'
		If Not &Exists
			&ApplicationPermission = new()
			&ApplicationPermission.Name			= &SecGAMFunctionalitiesToLoad.SecGAMFunctionalityKey
			If &SecGAMFunctionalitiesToLoad.SecGAMFunctionalityDsc <> ''
				&ApplicationPermission.Description 	= &SecGAMFunctionalitiesToLoad.SecGAMFunctionalityDsc
			Else
				&ApplicationPermission.Description 	= &SecGAMFunctionalitiesToLoad.SecGAMFunctionalityKey
			EndIf
			&ApplicationPermission.AccessType	= GAMPermissionAccessTypeDefault.Restricted
			msg(format(!"Adding permission '%1' to GAM repository...", &ApplicationPermission.Name.Trim()), status)
			&isOK = &GAMApplication.AddPermission(&ApplicationPermission, &Errors)
			If &isOK
				If not &Id.IsEmpty()
					//Grant access to administrator role
					&GAMPermission = new()
					&GAMPermission.ApplicationId = &GAMApplication.Id
					&GAMPermission.Description = &SecGAMFunctionalitiesToLoad.SecGAMFunctionalityKey
					&GAMPermission.Name = &ApplicationPermission.Name
					&GAMPermission.Type = GAMPermissionAccessType.Allow
					&GAMPermission.GUID = &ApplicationPermission.GUID
					msg(format(!"Adding permission '%1' to role '%2'...", &ApplicationPermission.Name.Trim(), &RoleName), status)
					&isOK = &GAMRole.AddPermission(&GAMPermission, &Errors)   
					If Not &isOK
						msg(format(!"The following errors ocurred while adding permission '%1' to role '%2':", &ApplicationPermission.Name.Trim(), &RoleName), status)
						do 'ShowErrorMessages'
					Endif
				Endif
			Else
				msg(format(!"The following errors ocurred while adding permission '%1':", &ApplicationPermission.Name.Trim()), status)
				do 'ShowErrorMessages'
			EndIf
		EndIf
	EndFor
EndIf
If &isOK
	Commit
	msg(!"The changes were commited", status)
Else
	msg(!"The changes were not commited", status)
EndIf


Sub 'SearchPermissionInDataProvider'

	&Exists = False
	For &SecGAMFunctionalitiesToLoad in &SecGAMFunctionalitiesToLoadCollection
		If &SecGAMFunctionalitiesToLoad.SecGAMFunctionalityKey = &GAMApplicationPermissionName
			&Exists = True
			Exit
		EndIf	
	EndFor

EndSub

Sub 'SearchPermissionAlreadyCreated'

	&Exists = False
	For &GAMApplicationPermission in &GAMApplicationPermissions
		If &GAMApplicationPermission.Name = &SecGAMFunctionalitiesToLoad.SecGAMFunctionalityKey
			&Exists = True
			Exit
		EndIf
	EndFor

EndSub

Sub 'ShowErrorMessages'

	For &Error in &Errors
		Msg(Format(!"%1 (GAM%2)", &Error.Message, &Error.Code), status)
	EndFor

EndSub

]]></Source>
        <Properties><Property><Name>IsDefault</Name><Value>False</Value></Property></Properties>
      </Part>
      <Part type="c414ed00-8cc4-4f44-8820-4baf93547173">
        <Properties />
      </Part>
      <Part type="9b0a32a3-de6d-4be1-a4dd-1b85d3741534">
        <Source><![CDATA[]]></Source>
        <Properties><Property><Name>IsDefault</Name><Value>False</Value></Property></Properties>
      </Part>
      <Part type="763f0d8b-d8ac-4db4-8dd4-de8979f2b5b9">
        <Source><![CDATA[]]></Source>
        <Properties><Property><Name>IsDefault</Name><Value>False</Value></Property></Properties>
      </Part>
      <Part type="e4c4ade7-53f0-4a56-bdfd-843735b66f47">
        <Variable Name="GAMPermissionFilter">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>GAMPermissionFilter</Value></Property><Property><Name>idIsAutoDefinedVariable</Name><Value>False</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMPermissionFilter</Value></Property></Properties>
        </Variable>
        <Variable Name="ApplicationPermission">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>ApplicationPermission</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMApplicationPermission</Value></Property></Properties>
        </Variable>
        <Variable Name="Error">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>Error</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMError</Value></Property></Properties>
        </Variable>
        <Variable Name="Errors">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>Errors</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMError</Value></Property><Property><Name>AttCollection</Name><Value>True</Value></Property></Properties>
        </Variable>
        <Variable Name="Exists">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>Exists</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>bas:Boolean</Value></Property></Properties>
        </Variable>
        <Variable Name="GAMApplication">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>GAMApplication</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMApplication</Value></Property></Properties>
        </Variable>
        <Variable Name="GAMApplicationId">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>GAMApplicationId</Value></Property><Property><Name>idBasedOn</Name><Value>Domain:GAMClientApplicationId</Value></Property></Properties>
        </Variable>
        <Variable Name="GAMApplicationPermission">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>GAMApplicationPermission</Value></Property><Property><Name>idIsAutoDefinedVariable</Name><Value>False</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMApplicationPermission</Value></Property></Properties>
        </Variable>
        <Variable Name="GAMApplicationPermissionFilter">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>GAMApplicationPermissionFilter</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMApplicationPermissionFilter</Value></Property></Properties>
        </Variable>
        <Variable Name="GAMApplicationPermissionName">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>GAMApplicationPermissionName</Value></Property><Property><Name>idBasedOn</Name><Value>Domain:GAMDescriptionLong</Value></Property></Properties>
        </Variable>
        <Variable Name="GAMApplicationPermissions">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>GAMApplicationPermissions</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMApplicationPermission</Value></Property><Property><Name>AttCollection</Name><Value>True</Value></Property></Properties>
        </Variable>
        <Variable Name="GAMPermission">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>GAMPermission</Value></Property><Property><Name>idIsAutoDefinedVariable</Name><Value>False</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMPermission</Value></Property></Properties>
        </Variable>
        <Variable Name="GAMRole">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>GAMRole</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMRole</Value></Property></Properties>
        </Variable>
        <Variable Name="GAMRoleFilter">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>GAMRoleFilter</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>exo:GAMRoleFilter</Value></Property></Properties>
        </Variable>
        <Variable Name="Id">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>Id</Value></Property><Property><Name>idBasedOn</Name><Value>Domain:GAMKeyNumLong</Value></Property></Properties>
        </Variable>
        <Variable Name="isOK">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>isOK</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>bas:Boolean</Value></Property></Properties>
        </Variable>
        <Variable Name="RoleName">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>RoleName</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>bas:VarChar</Value></Property></Properties>
        </Variable>
        <Variable Name="RoleNames">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>RoleNames</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>bas:VarChar</Value></Property></Properties>
        </Variable>
        <Variable Name="SecGAMFunctionalitiesToLoad">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>SecGAMFunctionalitiesToLoad</Value></Property><Property><Name>idIsAutoDefinedVariable</Name><Value>False</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>sdt:SecGAMFunctionalitiesToLoad</Value></Property></Properties>
        </Variable>
        <Variable Name="SecGAMFunctionalitiesToLoadCollection">
          <Documentation />
          <Help />
          <Properties><Property><Name>Name</Name><Value>SecGAMFunctionalitiesToLoadCollection</Value></Property><Property><Name>ATTCUSTOMTYPE</Name><Value>sdt:SecGAMFunctionalitiesToLoad</Value></Property><Property><Name>AttCollection</Name><Value>True</Value></Property></Properties>
        </Variable>
        <Properties><Property><Name>IsDefault</Name><Value>False</Value></Property></Properties>
      </Part>
      <Part type="ad3ca970-19d0-44e1-a7b7-db05556e820c">
        <Help>
          <HelpItem>
            <Language>88313f43-5eb2-0000-0028-e8d9f5bf9588-English</Language>
            <Content />
          </HelpItem>
        </Help>
        <Properties><Property><Name>IsDefault</Name><Value>False</Value></Property></Properties>
      </Part>
      <Part type="babf62c5-0111-49e9-a1c3-cc004d90900a">
        <Properties />
      </Part>
      <Properties><Property><Name>Name</Name><Value>SecGAMUpdatePermissions</Value></Property><Property><Name>Description</Name><Value>Sec GAMUpdate Permissions</Value></Property><Property><Name>CALL_PROTOCOL</Name><Value>CLINE</Value></Property><Property><Name>IntegratedSecurityPermissionPrefix</Name><Value>SecCreateApplicationPermissions</Value></Property><Property><Name>IsDefault</Name><Value>False</Value></Property></Properties>
    </Object>
  </Objects>
  <Attributes />
  <Dependencies>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Object" Id="84a12160-f59b-4ad7-a683-ea4481ac23e9">
      <Properties Name="Procedure" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="528d1c06-a9c2-420d-bd35-21dca83f12ff">
      <Properties Name="Source" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="c414ed00-8cc4-4f44-8820-4baf93547173">
      <Properties Name="Layout" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="9b0a32a3-de6d-4be1-a4dd-1b85d3741534">
      <Properties Name="Rules" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="763f0d8b-d8ac-4db4-8dd4-de8979f2b5b9">
      <Properties Name="Conditions" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="e4c4ade7-53f0-4a56-bdfd-843735b66f47">
      <Properties Name="Variables" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="ad3ca970-19d0-44e1-a7b7-db05556e820c">
      <Properties Name="Help" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="babf62c5-0111-49e9-a1c3-cc004d90900a">
      <Properties Name="Documentation" PackageName="GenexusBL" />
    </Reference>
  </Dependencies>
  <ObjectsIdentityMapping>
    <ObjectIdentity Type="00000000-0000-0000-0000-000000000008" Name="WWPBaseObjects.Security">
      <Guid>afa47377-41d5-4ae8-9755-6f53150aa361</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="2a9e9aba-d2de-4801-ae7f-5e3819222daf" Name="SecGAMGetAdvancedSecurityWWPFunctionalities">
      <Guid>21053622-870a-4b8c-a8b2-0405e8acbbfb</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="00972a17-9975-449e-aab1-d26165d51393" Name="GAMDescriptionLong">
      <Guid>f991f81c-eaeb-4fa9-8506-679169e49cd3</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="00972a17-9975-449e-aab1-d26165d51393" Name="GAMKeyNumLong">
      <Guid>0724441d-c822-4d50-82a6-3fbe887580f4</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="00972a17-9975-449e-aab1-d26165d51393" Name="GAMPermissionAccessType">
      <Guid>2a70d260-425e-42f7-beb9-0eb54e922a0b</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="00972a17-9975-449e-aab1-d26165d51393" Name="GAMClientApplicationId">
      <Guid>5003a80d-c8b5-48b7-9c75-10a0ca40559a</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="00972a17-9975-449e-aab1-d26165d51393" Name="GAMPermissionAccessTypeDefault">
      <Guid>02e55a7a-c4e9-4791-88cf-733b6d883d87</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="c163e562-42c6-4158-ad83-5b21a14cf30e" Name="GAMError">
      <Guid>cfbf5d75-050d-4960-81b5-42e2e47af44d</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="c163e562-42c6-4158-ad83-5b21a14cf30e" Name="GAMRepository">
      <Guid>1f5e2657-1fab-42bc-b23f-a04fe72e1870</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="c163e562-42c6-4158-ad83-5b21a14cf30e" Name="GAMRole">
      <Guid>d8668d6d-10df-4c7f-94c1-1ca41533f70f</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="c163e562-42c6-4158-ad83-5b21a14cf30e" Name="GAMRoleFilter">
      <Guid>eb186e82-905d-45ce-97fd-01289da5cba3</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="c163e562-42c6-4158-ad83-5b21a14cf30e" Name="GAMApplication">
      <Guid>981582ad-ca8a-4c5a-99a3-7f8a187d48fd</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="c163e562-42c6-4158-ad83-5b21a14cf30e" Name="GAMApplicationPermissionFilter">
      <Guid>a4edb939-102b-44cb-929f-7db53c371cbf</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="c163e562-42c6-4158-ad83-5b21a14cf30e" Name="GAMApplicationPermission">
      <Guid>f7c47261-bba9-4ad5-acf9-050aa1b5bdf7</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="c163e562-42c6-4158-ad83-5b21a14cf30e" Name="GAMPermissionFilter">
      <Guid>945f21dc-2349-418e-aa95-ba3b57d8d5bf</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="c163e562-42c6-4158-ad83-5b21a14cf30e" Name="GAMPermission">
      <Guid>f64b765d-7ea2-44cd-bb71-0a0846e3699e</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="447527b5-9210-4523-898b-5dccb17be60a" Name="SecGAMFunctionalitiesToLoad">
      <Guid>e5a770e2-356e-4202-b553-1bee8b33846d</Guid>
    </ObjectIdentity>
  </ObjectsIdentityMapping>
</ExportFile>