<?xml version="1.0" encoding="utf-8"?>
<ExportFile>
  <KMW>
    <MajorVersion>3</MajorVersion>
    <MinorVersion>1</MinorVersion>
    <Build>80183</Build>
  </KMW>
  <Source kb="836c5f09-8777-4129-a040-61f24d93c42a" UNCPath="\\PCKBS\C$\Projects\KBs\Ev2\KBSecurity">
    <Version guid="7043d77a-8594-4c26-8be1-51830a89cb33" name="KBSecurity" />
  </Source>
  <Actions />
  <Objects>
    <Object parent="Security" parentType="00000000-0000-0000-0000-000000000008" parentGuid="2c01440d-1215-4aa3-81fe-3334dd0a38f6"  checksum="97cd66f5629a831a80cf05f4c0514bab" fullyQualifiedName="SecUpdateFuncionalities" guid="760f286a-4b77-44ea-89e2-124a03ef89b8" name="SecUpdateFuncionalities" type="84a12160-f59b-4ad7-a683-ea4481ac23e9" description="Sec Load Security Tables">
      <Part type="528d1c06-a9c2-420d-bd35-21dca83f12ff">
        <Source>
      <![CDATA[
	/* Generated by DVelop Work With Plus Pattern [Start] - Do not change */

&RoleName = !''
&AdminUserName = !''

	/* Generated by DVelop Work With Plus Pattern [End] - Do not change */

msg(format("Administrator role: '%1'", &RoleName), status)

//Delete all Objects-Functionality associations
For Each //SecObjectFunctionalities
	Defined By SecObjectName, SecFunctionalityId
	Delete
EndFor

//Delete all Objects
For Each //SecObject
	Defined By SecObjectName
	Delete
EndFor

//Change all Functionalities to 'Inactive' and reset Parent
For Each //SecFunctionality 
	SecFunctionalityActive = False
	SecParentFunctionalityId.SetNull()
EndFor

Commit

&SecFunctionalitiesToLoadCollection = SecGetAdvancedSecurityWWPFunctionalities()

//Create and update all Functionalities
For &SecFunctionalitiesToLoad in &SecFunctionalitiesToLoadCollection
	For &SecFunctionalityKey in &SecFunctionalitiesToLoad.SecFunctionalityKeys
		For Each //SecFunctionality
			Where SecFunctionalityKey = &SecFunctionalityKey.SecFunctionalityKey
			SecParentFunctionalityId.SetNull()
			SecFunctionalityActive				= True
			SecFunctionalityType.SetEmpty()
		When None
			msg(format(!"Adding functionality '%1'...", &SecFunctionalityKey.SecFunctionalityKey), status)
			New //SecFunctionality
				SecFunctionalityKey					= &SecFunctionalityKey.SecFunctionalityKey
				SecFunctionalityDescription			= &SecFunctionalityKey.SecFunctionalityDsc
				SecParentFunctionalityId.SetNull()
				SecFunctionalityActive				= True
				SecFunctionalityType.SetEmpty()
			EndNew
		EndFor
	EndFor
EndFor

//Delete Functionalities (and their associations) that are no longer used
For Each //SecFunctionality
	Where SecFunctionalityActive = False
	For Each //SecFunctionalityRole
		Defined By SecRoleId, SecFunctionalityId
		msg(format(!"Deleting functionality '%1' from role '%2'...", SecFunctionalityKey, SecRoleName), status)
		Delete
	EndFor
	msg(format(!"Deleting functionality '%1'...", SecFunctionalityKey), status)
	Delete
EndFor

//Update Functionalities Type and Parents (for Actions, Tabs, and Modes)
For &SecFunctionalitiesToLoad in &SecFunctionalitiesToLoadCollection
	For &SecFunctionalityKey in &SecFunctionalitiesToLoad.SecFunctionalityKeys
		For Each //SecFunctionality
			Where SecFunctionalityKey = &SecFunctionalityKey.SecFunctionalityKey
			SecFunctionalityDescription = &SecFunctionalityKey.SecFunctionalityDsc
			//Update Functionality Type
			If SecFunctionalityType.IsEmpty()
				SecFunctionalityType = &SecFunctionalitiesToLoad.SecFunctionalityType
			Else
				If SecFunctionalityType <> &SecFunctionalitiesToLoad.SecFunctionalityType
					SecFunctionalityType = WWPSecFunctionalityTypes.Object
					SecParentFunctionalityId.SetNull()
				EndIf
			EndIf
			
			//Update Functionality Parent
			If SecFunctionalityType <> WWPSecFunctionalityTypes.Object AND not &SecFunctionalitiesToLoad.SecParentFunctionalityKey.IsEmpty()
				&SecFunctionalityKeyToFilter = &SecFunctionalitiesToLoad.SecParentFunctionalityKey
				Do 'GetFunctionalityIdByKey'
				If SecParentFunctionalityId <> &SecFunctionalityId
					If SecParentFunctionalityId.IsNull() AND (not &SecFunctionalityId.IsEmpty()) AND SecFunctionalityActive
						SecParentFunctionalityId = &SecFunctionalityId
					Else
						// The SecFunctionalityActive is used to tag Functionalities that will have Empty Parent (because they have more than one parent)
						SecFunctionalityActive = False
						SecParentFunctionalityId.SetNull()
					EndIf
				EndIf
			EndIf
		EndFor
	EndFor
EndFor

//Update SecFunctionalityActive
For Each //SecFunctionality
	Where SecFunctionalityActive = False
	SecFunctionalityActive = True
EndFor

//Create All Objects and Objects-Functionality association
For &SecFunctionalitiesToLoad in &SecFunctionalitiesToLoadCollection
	If Not &SecFunctionalitiesToLoad.SecObjectName.IsEmpty()
		New //SecObject
			SecObjectName = trim(lower(&SecFunctionalitiesToLoad.SecObjectName))
		EndNew
		For &SecFunctionalityKey in &SecFunctionalitiesToLoad.SecFunctionalityKeys
			&SecFunctionalityKeyToFilter = &SecFunctionalityKey.SecFunctionalityKey
			Do 'GetFunctionalityIdByKey'
			If not &SecFunctionalityId.IsEmpty()
				New //SecObjectFunctionalities
					SecObjectName = trim(lower(&SecFunctionalitiesToLoad.SecObjectName))
					SecFunctionalityId = &SecFunctionalityId
				EndNew
			EndIf
		EndFor
	EndIf
EndFor

Commit

If &RoleName <> ''
	If &AdminUserName <> ''
		&AssignRoleToUser = True
	Else
		&AssignRoleToUser = False
	EndIf
	SecGrantAllAccessToAdminRole.Call(&RoleName, &AssignRoleToUser, &AdminUserName)
EndIf


Sub 'GetFunctionalityIdByKey'

	&SecFunctionalityId = Find(SecFunctionalityId, SecFunctionalityKey = &SecFunctionalityKeyToFilter, 0)
	If &SecFunctionalityId.IsEmpty()
		msg(format(!"Functionality '%1' not found", &SecFunctionalityKeyToFilter), status)
	EndIf

EndSub

]]>
        </Source>
        <Properties>
          <Property>
            <Name>IsDefault</Name>
            <Value>False</Value>
          </Property>
        </Properties>
      </Part>
      <Part type="c414ed00-8cc4-4f44-8820-4baf93547173">
        <Properties />
      </Part>
      <Part type="9b0a32a3-de6d-4be1-a4dd-1b85d3741534">
        <Source><![CDATA[]]></Source>
        <Properties>
          <Property>
            <Name>IsDefault</Name>
            <Value>False</Value>
          </Property>
        </Properties>
      </Part>
      <Part type="763f0d8b-d8ac-4db4-8dd4-de8979f2b5b9">
        <Source><![CDATA[]]></Source>
        <Properties>
          <Property>
            <Name>IsDefault</Name>
            <Value>False</Value>
          </Property>
        </Properties>
      </Part>
      <Part type="e4c4ade7-53f0-4a56-bdfd-843735b66f47">
        <Variable Name="SecFunctionalitiesToLoadCollection">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>SecFunctionalitiesToLoadCollection</Value>
            </Property>
            <Property>
              <Name>idIsAutoDefinedVariable</Name>
              <Value>False</Value>
            </Property>
            <Property>
              <Name>ATTCUSTOMTYPE</Name>
              <Value>sdt:SecFunctionalitiesToLoad</Value>
            </Property>
            <Property>
              <Name>AttCollection</Name>
              <Value>True</Value>
            </Property>
          </Properties>
        </Variable>
        <Variable Name="SecFunctionalityId">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>SecFunctionalityId</Value>
            </Property>
            <Property>
              <Name>idBasedOn</Name>
              <Value>Attribute:SecFunctionalityId</Value>
            </Property>
          </Properties>
        </Variable>
        <Variable Name="SecFunctionalityIdFound">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>SecFunctionalityIdFound</Value>
            </Property>
            <Property>
              <Name>ATTCUSTOMTYPE</Name>
              <Value>bas:Boolean</Value>
            </Property>
          </Properties>
        </Variable>
        <Variable Name="SecFunctionalityKey">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>SecFunctionalityKey</Value>
            </Property>
            <Property>
              <Name>ATTCUSTOMTYPE</Name>
              <Value>sdt:SecFunctionalitiesToLoad.SecFunctionalityKeysItem</Value>
            </Property>
          </Properties>
        </Variable>
        <Variable Name="SecFunctionalityKeyToFilter">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>SecFunctionalityKeyToFilter</Value>
            </Property>
            <Property>
              <Name>idBasedOn</Name>
              <Value>Attribute:SecFunctionalityKey</Value>
            </Property>
          </Properties>
        </Variable>
        <Variable Name="SecFunctionalitiesToLoad">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>SecFunctionalitiesToLoad</Value>
            </Property>
            <Property>
              <Name>idIsAutoDefinedVariable</Name>
              <Value>False</Value>
            </Property>
            <Property>
              <Name>ATTCUSTOMTYPE</Name>
              <Value>sdt:SecFunctionalitiesToLoad</Value>
            </Property>
          </Properties>
        </Variable>
        <Variable Name="SecObjectName">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>SecObjectName</Value>
            </Property>
            <Property>
              <Name>idBasedOn</Name>
              <Value>Attribute:SecObjectName</Value>
            </Property>
          </Properties>
        </Variable>
        <Variable Name="FunctionalitiesCount">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>FunctionalitiesCount</Value>
            </Property>
            <Property>
              <Name>Length</Name>
              <Value>10</Value>
            </Property>
            <Property>
              <Name>AttMaxLen</Name>
              <Value>10</Value>
            </Property>
          </Properties>
        </Variable>
        <Variable Name="RoleName">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>RoleName</Value>
            </Property>
            <Property>
              <Name>ATTCUSTOMTYPE</Name>
              <Value>bas:VarChar</Value>
            </Property>
            <Property>
              <Name>Length</Name>
              <Value>100</Value>
            </Property>
            <Property>
              <Name>AttMaxLen</Name>
              <Value>100</Value>
            </Property>
          </Properties>
        </Variable>
        <Variable Name="AdminUserName">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>AdminUserName</Value>
            </Property>
            <Property>
              <Name>ATTCUSTOMTYPE</Name>
              <Value>bas:VarChar</Value>
            </Property>
            <Property>
              <Name>Length</Name>
              <Value>100</Value>
            </Property>
            <Property>
              <Name>AttMaxLen</Name>
              <Value>100</Value>
            </Property>
          </Properties>
        </Variable>
        <Variable Name="AssignRoleToUser">
          <Documentation />
          <Help />
          <Properties>
            <Property>
              <Name>Name</Name>
              <Value>AssignRoleToUser</Value>
            </Property>
            <Property>
              <Name>ATTCUSTOMTYPE</Name>
              <Value>bas:Boolean</Value>
            </Property>
          </Properties>
        </Variable>
        <Properties>
          <Property>
            <Name>IsDefault</Name>
            <Value>False</Value>
          </Property>
        </Properties>
      </Part>
      <Part type="ad3ca970-19d0-44e1-a7b7-db05556e820c">
        <Help>
          <HelpItem>
            <Language>88313f43-5eb2-0000-0028-e8d9f5bf9588-English</Language>
            <Content />
          </HelpItem>
        </Help>
        <Properties>
          <Property>
            <Name>IsDefault</Name>
            <Value>False</Value>
          </Property>
        </Properties>
      </Part>
      <Part type="babf62c5-0111-49e9-a1c3-cc004d90900a">
        <Properties />
      </Part>
      <Properties>
        <Property>
          <Name>Name</Name>
          <Value>SecUpdateFuncionalities</Value>
        </Property>
        <Property>
          <Name>Description</Name>
          <Value>Sec Load Security Tables</Value>
        </Property>
        <Property>
          <Name>IsMain</Name>
          <Value>True</Value>
        </Property>
        <Property>
          <Name>CALL_PROTOCOL</Name>
          <Value>CLINE</Value>
        </Property>
        <Property>
          <Name>IsDefault</Name>
          <Value>False</Value>
        </Property>
      </Properties>
    </Object>
  </Objects>
  <Attributes />
  <Dependencies>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Object" Id="84a12160-f59b-4ad7-a683-ea4481ac23e9">
      <Properties Name="Procedure" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="528d1c06-a9c2-420d-bd35-21dca83f12ff">
      <Properties Name="Source" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="c414ed00-8cc4-4f44-8820-4baf93547173">
      <Properties Name="Layout" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="9b0a32a3-de6d-4be1-a4dd-1b85d3741534">
      <Properties Name="Rules" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="763f0d8b-d8ac-4db4-8dd4-de8979f2b5b9">
      <Properties Name="Conditions" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="e4c4ade7-53f0-4a56-bdfd-843735b66f47">
      <Properties Name="Variables" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="ad3ca970-19d0-44e1-a7b7-db05556e820c">
      <Properties Name="Help" PackageName="GenexusBL" />
    </Reference>
    <Reference Package="3ea7e1c6-b849-4df9-931a-070171a8a2f0" Type="Part" Id="babf62c5-0111-49e9-a1c3-cc004d90900a">
      <Properties Name="Documentation" PackageName="GenexusBL" />
    </Reference>
  </Dependencies>
  <ObjectsIdentityMapping>
    <ObjectIdentity Type="00000000-0000-0000-0000-000000000008" Name="Security">
      <Guid>2c01440d-1215-4aa3-81fe-3334dd0a38f6</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="adbb33c9-0906-4971-833c-998de27e0676" Name="SecFunctionalityActive">
      <Guid>df55b198-5540-463c-b2b1-eddc36d73138</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="adbb33c9-0906-4971-833c-998de27e0676" Name="SecFunctionalityDescription">
      <Guid>382f12fd-3da7-45ae-90bc-15ac12556463</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="adbb33c9-0906-4971-833c-998de27e0676" Name="SecFunctionalityId">
      <Guid>adece4c3-97fd-4f66-9cc8-4a48b0ccbee8</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="adbb33c9-0906-4971-833c-998de27e0676" Name="SecFunctionalityKey">
      <Guid>51f23b14-581f-4a46-8905-ad2779f57052</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="adbb33c9-0906-4971-833c-998de27e0676" Name="SecFunctionalityType">
      <Guid>e12e6ead-afd3-49fb-ae3c-d7be8eea74b5</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="adbb33c9-0906-4971-833c-998de27e0676" Name="SecObjectName">
      <Guid>cf106f4b-293b-4f4d-87b6-6f79f8ae2f87</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="adbb33c9-0906-4971-833c-998de27e0676" Name="SecParentFunctionalityId">
      <Guid>c35056a8-8d48-4fc9-96ff-e13acdc51455</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="adbb33c9-0906-4971-833c-998de27e0676" Name="SecRoleId">
      <Guid>c63270dd-6190-4a93-8ae5-6087a58f0484</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="adbb33c9-0906-4971-833c-998de27e0676" Name="SecRoleName">
      <Guid>8b664a7e-93f2-46e4-a861-7eefe1f3b9db</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="2a9e9aba-d2de-4801-ae7f-5e3819222daf" Name="SecGetAdvancedSecurityWWPFunctionalities">
      <Guid>050ff294-b279-4834-a0ff-98a6c099e201</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="00972a17-9975-449e-aab1-d26165d51393" Name="WWPSecFunctionalityTypes">
      <Guid>44e3b9f1-8090-4a28-96c9-c5bef03e380a</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="84a12160-f59b-4ad7-a683-ea4481ac23e9" Name="SecGrantAllAccessToAdminRole">
      <Guid>39b2f1c1-2c66-46c2-a7f1-054b22debcb5</Guid>
    </ObjectIdentity>
    <ObjectIdentity Type="447527b5-9210-4523-898b-5dccb17be60a" Name="SecFunctionalitiesToLoad">
      <Guid>c2935a7f-ecf6-4939-883b-100feef59dde</Guid>
    </ObjectIdentity>
  </ObjectsIdentityMapping>
</ExportFile>